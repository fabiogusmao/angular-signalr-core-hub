angular.module("SignalR",[]).factory("Hub",["$q","$log","$timeout",function(n,t,e){"use strict";var o=function(n,c){var r=this;var i=null;function a(n){var t={oldState:i,newState:n};return n!==i&&(i=n),t}function s(s){if(t.log("Hub "+n+' changed from "'+i+'" to "'+s+'"'),c.stateChanged){var u=a(s);c.stateChanged(u),l&&(l=!1),s===o.connectionStates.disconnected&&c.autoReconnect&&(u=a(o.connectionStates.reconnecting),c.stateChanged(u),e(function(){r.start()},c.reconnectTimeout||1e3))}}var u=null,d=[],l=!1;c.methods&&c.methods.map(function(e){var o=new function(e){return function(){t.debug(n,"Calling method "+e);var o=Array.prototype.slice.call(arguments);return o=[e].concat(o),u.send.apply(u,o)}}(e);r[e]=o}),this.start=function(){var e="WebSocket"in window||"MozWebSocket"in window,r=void 0;return c.forceWebSocket&&e&&(r={transport:signalR.TransportType.WebSockets}),(u=new signalR.HubConnection(function(){var e=c.rootPath+"/"+n,o=[];for(var r in c.queryParams)c.queryParams.hasOwnProperty(r)&&o.push(r+"="+c.queryParams[r]);return e+="?"+o.join("&"),t.debug("Hub",n,"url",e),e}(),r)).onclose(function(e){t.log("Connection Closed",n),e&&t.error(e),s(o.connectionStates.disconnected)}),function(){if(c.listeners)for(var n in c.listeners)if(c.listeners.hasOwnProperty(n)){var t=c.listeners[n];u.on(n,t)}}(),d.map(function(n){u.on(n.method,n.handler)}),u.start().then(function(){s(o.connectionStates.connected)},function(){if(t.error("Connection to SignalR Hub "+n+" failed!"),null===i)throw Error("Error connecting to SignalR!");s(o.connectionStates.disconnected)})},this.stop=function(){null!==u&&(l=!0,u.stop())},this.isConnected=function(){return u&&1===u.connection.connectionState},this.on=function(n,t){u&&u.on(n,t),d.push({method:n,handler:t})},this.off=function(n,t){u&&u.off(n,t);var e=d.findIndex(function(e){return e.method===n&&e.handler===t});e>=0&&d.splice(e,1)},c.autoStart&&this.start()};return o.connectionStates={connecting:"connecting",connected:"connected",reconnecting:"reconnecting",disconnected:"disconnected"},o}]);